rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper : Vérifie si l'utilisateur est connecté
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper : Vérifie si l'utilisateur agit sur ses propres données
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper : Vérifie si l'utilisateur est admin via le Custom Claim
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // --- RÈGLES UTILISATEURS ---
    match /users/{userId} {
      // Lecture : Soi-même ou Admin
      allow read: if isOwner(userId) || isAdmin();
      
      // CRÉATION SÉCURISÉE : On force les valeurs par défaut
      allow create: if isOwner(userId)
        && request.resource.data.role == 'user'
        && request.resource.data.points == 0
        && request.resource.data.balance_cents == 0
        // On s'assure que l'email correspond au compte auth
        && request.resource.data.email == request.auth.token.email;

      // MODIFICATION : Interdiction de toucher aux champs sensibles
      allow update: if isOwner(userId) 
        && !request.resource.data.diff(resource.data).affectedKeys()
            .hasAny(['points', 'role', 'balance_cents', 'points_history', 'bad_luck_count']);

      // Admin a tous les droits
      allow write: if isAdmin();
    }

    // --- RÈGLES PRODUITS ---
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- RÈGLES COMMANDES ---
    match /orders/{orderId} {
      allow read: if isOwner(resource.data.user_id) || isAdmin();
      
      // Création sécurisée d'une commande
      allow create: if isOwner(request.resource.data.user_id)
        && request.resource.data.status == 'created'
        && request.resource.data.points_earned == null
        // Vérification basique du total (optionnel mais recommandé)
        && request.resource.data.total_cents >= 0;

      allow update: if isAdmin();
    }
    
    // --- NOUVEAU : RÈGLE POUR LE LEADERBOARD AGGRÉGÉ ---
    // Seul l'admin (ou la Cloud Function) peut écrire, tout le monde peut lire
    match /stats/leaderboard {
      allow read: if isAuthenticated();
      allow write: if false; // Seul le backend peut écrire via le SDK Admin
    }
  }
}